import geopandas as gpd
import matplotlib.pyplot as plt
import contextily as ctx
from shapely.geometry import Point

# Example coordinates (lon, lat)
coords = [
    (-73.9857, 40.7484),  # NYC
    (-0.1276, 51.5072),   # London
    (2.3522, 48.8566),    # Paris
]

gdf = gpd.GeoDataFrame(
    geometry=[Point(lon, lat) for lon, lat in coords],
    crs="EPSG:4326",
).to_crs(epsg=3857)

# Match the plot window aspect to the block aspect ratio.
# Adjust this if your GTK window is wider/narrower.
target_aspect = 16 / 9  # width / height

fig, ax = plt.subplots(figsize=(8, 5))
gdf.plot(ax=ax, color="#d0d0d0", markersize=60, alpha=0.9)

# Add a dark basemap (requires network access)
ctx.add_basemap(ax, source=ctx.providers.CartoDB.DarkMatter)

# Fit bounds, then expand the shorter dimension to match target aspect
minx, miny, maxx, maxy = gdf.total_bounds
width = maxx - minx
height = maxy - miny

pad = 0.1
minx -= width * pad
maxx += width * pad
miny -= height * pad
maxy += height * pad

width = maxx - minx
height = maxy - miny
current_aspect = width / height if height else target_aspect

if current_aspect > target_aspect:
    # too wide -> expand height
    new_height = width / target_aspect
    delta = (new_height - height) / 2
    miny -= delta
    maxy += delta
else:
    # too tall -> expand width
    new_width = height * target_aspect
    delta = (new_width - width) / 2
    minx -= delta
    maxx += delta

ax.set_xlim(minx, maxx)
ax.set_ylim(miny, maxy)

ax.set_axis_off()
ax.set_aspect("equal")

fig.savefig(__gtkv__.renderer, format="svg", dpi=200, transparent=True)
