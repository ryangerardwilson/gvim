name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version env
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          echo "TAG=${TAG}" >> "$GITHUB_ENV"
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"

      - name: Build linux-x64 binary in manylinux2014
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          docker run --rm \
            -e GITHUB_TOKEN="${GITHUB_TOKEN:-}" \
            -e VERSION="${VERSION}" \
            -v "${GITHUB_WORKSPACE}:/work" \
            -w /work \
            quay.io/pypa/manylinux2014_x86_64 \
            bash -lc '
              set -euo pipefail
              yum -y install curl zstd
              PY_URL=$(/opt/python/cp311-cp311/bin/python .github/scripts/find-python-url.py)
              test -n "$PY_URL"
              echo "Using python-build-standalone: $PY_URL"
              curl -fL "$PY_URL" -o /tmp/python.tar
              mkdir -p /opt/py
              case "$PY_URL" in
                *.tar.zst)
                  tar --use-compress-program=unzstd -xf /tmp/python.tar -C /opt/py
                  ;;
                *.tar.gz)
                  tar -xzf /tmp/python.tar -C /opt/py
                  ;;
                *)
                  echo "Unknown python archive format: $PY_URL" >&2
                  exit 1
                  ;;
              esac

              PYBIN="/opt/py/python/bin/python3"
              export LD_LIBRARY_PATH="/opt/py/python/lib:${LD_LIBRARY_PATH:-}"
              "$PYBIN" -m pip install -U pip
              echo "__version__ = \"${VERSION}\"" > _version.py
              mkdir -p dist/gtkv
              cp -a main.py orchestrator.py config.py _version.py requirements.txt AGENTS.md README.md \
                editor_command_controller.py editor_command_parser.py editor_commands_insert.py \
                editor_commands_normal.py editor_commands_visual.py editor_document.py editor_mode_router.py \
                editor_segments.py editor_state.py logging_debug.py persistence_gtkv_html.py \
                services_image_cache.py ui_command_pane.py ui_editor_view.py ui_status_controller.py \
                ui_window_shell.py dist/gtkv/
              cp -a completions_gtkv.bash dist/gtkv/
              tar -C dist -czf gtkv-linux-x64.tar.gz gtkv

            '

      - name: Create release and upload asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          files: |
            gtkv-linux-x64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
